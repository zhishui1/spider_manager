# RESTful API 开发计划

## 准备工作：添加爬虫唯一标识符

在 `backend/spiders/crawlers/nhsa/config.py` 中添加：

```python
SPIDER_ID = 'nhsa_2024'
SPIDER_NAME = 'nhsa'
SPIDER_DISPLAY_NAME = '国家医保局爬虫'
```

---

## API设计规范

### HTTP方法选择
- **GET**: 用于获取数据和小型文件下载
- **POST**: 用于批量下载（item_ids可能较多）

### 参数形式
- 主资源标识（spider_id）：**路径参数**
- 从属资源标识（item_id）：**路径参数**
- 批量下载列表：**POST请求体JSON**

---

## 新增5个API接口

### 1. 获取爬虫项目列表

* **端点**: `GET /api/v1/spiders/list`
* **参数**: 无
* **响应 (200)**:

```json
{
  "success": true,
  "data": [
    {"spider_id": "nhsa_2024", "spider_name": "nhsa", "spider_display_name": "国家医保局爬虫"}
  ]
}
```

### 2. 获取爬虫项目详细信息

* **端点**: `GET /api/v1/spiders/{spider_id}/stats`
* **参数**: 路径参数 `spider_id`
* **响应 (200)**:

```json
{
  "success": true,
  "data": {
    "spider_id": "nhsa_2024",
    "spider_name": "nhsa",
    "spider_display_name": "国家医保局爬虫",
    "collected_links": 1500,
    "pending_links": 50,
    "crawled_links": 1450,
    "file_count": 3200,
    "error_count": 5
  }
}
```

### 3. 下载爬虫项目JSON文件

* **端点**: `GET /api/v1/spiders/{spider_id}/json`
* **参数**: 路径参数 `spider_id`
* **响应**: 文件下载流

### 4. 下载单个item_id文件包

* **端点**: `GET /api/v1/spiders/{spider_id}/items/{item_id}/download`
* **参数**: 路径参数 `spider_id`, `item_id`
* **响应**: ZIP文件下载流

### 5. 批量下载多个item_id文件包

* **端点**: `POST /api/v1/spiders/{spider_id}/items/batch-download`
* **参数**: 
  - 路径参数 `spider_id`
  - 请求体: `{"item_ids": ["123", "456", "789"]}`
* **响应**: ZIP文件下载流
* **错误响应 (400)**:

```json
{
  "success": false,
  "error": "部分item_id不存在",
  "missing_item_ids": ["1234567890"]
}
```

---

## 开发步骤

### Step 1: 添加 SPIDER_ID 配置
- `backend/spiders/crawlers/nhsa/config.py`

### Step 2: 修改 `backend/spiders/urls.py`
- 新增5个路由

### Step 3: 修改 `backend/spiders/views.py`
- 新增5个视图函数（1个GET, 4个GET, 1个POST）

### Step 4: 创建 `backend/spiders/file_utils.py`
- ZIP打包工具函数

### Step 5: 测试验证

---

## 错误处理规范

| 场景 | 状态码 | 响应 |
|------|--------|------|
| 成功 | 200 | `{"success": true, "data": {...}}` 或文件流 |
| 参数无效 | 400 | `{"success": false, "error": "..."}` |
| 资源不存在 | 404 | `{"success": false, "error": "..."}` |
| 服务器错误 | 500 | `{"success": false, "error": "服务器内部错误"}` |

